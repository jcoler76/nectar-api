<!DOCTYPE html>
<html>
<head>
    <title>Debug Frontend Auth</title>
</head>
<body>
    <h1>Debug Frontend Authentication</h1>
    <div id="output"></div>
    
    <script>
        function debugAuth() {
            const output = document.getElementById('output');
            let html = '<h2>üîç Frontend Auth Debug</h2>';
            
            // Check localStorage
            html += '<h3>üì¶ LocalStorage:</h3><pre>';
            const localStorageUser = localStorage.getItem('user');
            html += `user: ${localStorageUser || 'null'}\n`;
            const localStorageToken = localStorage.getItem('token');
            html += `token: ${localStorageToken || 'null'}\n`;
            html += '</pre>';
            
            // Check sessionStorage
            html += '<h3>üóÑÔ∏è SessionStorage:</h3><pre>';
            const sessionStorageUser = sessionStorage.getItem('user');
            html += `user: ${sessionStorageUser || 'null'}\n`;
            const sessionStorageToken = sessionStorage.getItem('token');
            html += `token: ${sessionStorageToken || 'null'}\n`;
            html += '</pre>';
            
            // Check for encrypted storage (mirabel_session)
            html += '<h3>üîê Encrypted Storage:</h3><pre>';
            const encryptedSession = localStorage.getItem('mirabel_session');
            html += `mirabel_session: ${encryptedSession || 'null'}\n`;
            html += '</pre>';
            
            // Try to decode any JWT tokens found
            const tokens = [localStorageToken, sessionStorageToken];
            
            if (localStorageUser) {
                try {
                    const userData = JSON.parse(localStorageUser);
                    if (userData.token) {
                        tokens.push(userData.token);
                    }
                } catch (e) {
                    console.error('Error parsing localStorage user:', e);
                }
            }
            
            if (sessionStorageUser) {
                try {
                    const userData = JSON.parse(sessionStorageUser);
                    if (userData.token) {
                        tokens.push(userData.token);
                    }
                } catch (e) {
                    console.error('Error parsing sessionStorage user:', e);
                }
            }
            
            html += '<h3>üé´ JWT Token Analysis:</h3>';
            
            tokens.forEach((token, index) => {
                if (token && token !== 'null') {
                    try {
                        const payload = token.split('.')[1];
                        const decoded = JSON.parse(atob(payload));
                        html += `<h4>Token ${index + 1}:</h4><pre>${JSON.stringify(decoded, null, 2)}</pre>`;
                        
                        // Check if isAdmin is present
                        if (decoded.isAdmin !== undefined) {
                            html += `<p><strong>isAdmin: ${decoded.isAdmin}</strong></p>`;
                        }
                    } catch (e) {
                        html += `<p>Token ${index + 1}: Invalid JWT format</p>`;
                    }
                }
            });
            
            // Instructions
            html += '<h3>üîß Next Steps:</h3>';
            html += '<ol>';
            html += '<li>Clear all browser storage and try fresh login</li>';
            html += '<li>Check if isAdmin: true appears in JWT token</li>';
            html += '<li>Verify frontend receives and stores the isAdmin flag</li>';
            html += '</ol>';
            
            html += '<button onclick="clearAllStorage()">Clear All Storage</button>';
            
            output.innerHTML = html;
        }
        
        function clearAllStorage() {
            localStorage.clear();
            sessionStorage.clear();
            alert('All storage cleared! Now try logging in again.');
        }
        
        // Run debug on page load
        debugAuth();
    </script>
</body>
</html>